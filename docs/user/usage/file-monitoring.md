# File Monitoring and Processing

Meet2Obsidian автоматически отслеживает указанные директории на наличие новых видеофайлов и обрабатывает их по мере появления. Это руководство объясняет, как работают системы мониторинга файлов и обработки очереди, а также как их настроить.

## Как работает мониторинг файлов и обработка очереди

Meet2Obsidian использует двухуровневую систему для обработки видеофайлов:

1. **Система мониторинга файлов** (FileMonitor) отслеживает указанную директорию на наличие новых видеофайлов с помощью событий файловой системы.

2. **Система обработки очереди** (ProcessingQueue) управляет очередью файлов для обработки, поддерживает приоритеты, отслеживает состояние обработки и обеспечивает восстановление после сбоев.

Весь процесс работает следующим образом:
1. Пользователь помещает видеофайлы в настроенную директорию (`paths.video_directory`)
2. FileMonitor обнаруживает новые файлы и добавляет их в очередь обработки
3. ProcessingQueue обрабатывает файлы в соответствии с их приоритетом
4. После успешной обработки файлы отмечаются как завершенные

## Ключевые возможности

### Мониторинг файлов

- **Эффективное отслеживание**: Использует нативные события файловой системы для немедленного обнаружения новых файлов
- **Определение стабильности файлов**: Гарантирует, что файлы полностью скопированы перед началом обработки
- **Фильтрация по шаблонам**: Обрабатывает только файлы, соответствующие настроенным шаблонам (например, видеофайлы)
- **Персистентность**: Запоминает, какие файлы были обработаны, чтобы избежать дублирования после перезапуска
- **Низкое использование ресурсов**: Минимальное влияние на CPU и дисковый ввод/вывод

### Система обработки очереди

- **Приоритетная обработка**: Файлы с более высоким приоритетом обрабатываются первыми
- **Отслеживание состояния**: Полное отслеживание состояния каждого файла (ожидание, обработка, завершено, ошибка)
- **Обработка ошибок**: Автоматические повторные попытки обработки файлов с ошибками
- **Параллельная обработка**: Поддержка многопоточной обработки для лучшей производительности
- **Восстановление после сбоев**: Сохранение и загрузка состояния очереди для восстановления после перезапуска

## Настройка директории для видеофайлов

### Где разместить ваши видеофайлы

По умолчанию Meet2Obsidian ищет видеофайлы в директории:

```
/Users/username/Documents/meet_records/
```

Вы можете изменить эту директорию через конфигурационный файл или с помощью CLI:

```bash
meet2obsidian config set paths.video_directory "/path/to/your/videos"
```

> **Важно**: Это ключевая настройка — система не будет отслеживать файлы в других директориях, кроме указанной в `paths.video_directory`.

### Проверка текущей директории

Чтобы узнать, какая директория сейчас настроена для отслеживания:

```bash
meet2obsidian config get paths.video_directory
```

## Параметры конфигурации

Вы можете настроить мониторинг файлов и обработку очереди через CLI `meet2obsidian`:

### Настройка шаблонов файлов

```bash
meet2obsidian config set processing.file_patterns '["*.mp4", "*.mov", "*.webm", "*.mkv"]'
```

По умолчанию отслеживаются следующие типы файлов:
- `*.mp4`
- `*.mov`
- `*.webm`
- `*.mkv`

### Настройка минимального возраста файла

```bash
meet2obsidian config set processing.min_file_age_seconds 10
```

Этот параметр определяет, сколько секунд файл должен быть стабильным (не меняющимся в размере) перед началом обработки. По умолчанию — 5 секунд.

### Настройка параллельной обработки

```bash
meet2obsidian config set processing.max_concurrent_files 2
```

Устанавливает максимальное количество файлов, которые могут обрабатываться одновременно. По умолчанию — 2.

### Настройка попыток повторной обработки

```bash
meet2obsidian config set processing.max_retries 3
```

Определяет, сколько раз система попытается повторно обработать файл в случае ошибки. По умолчанию — 3.

## Проверка статуса мониторинга

Вы можете проверить статус службы мониторинга файлов с помощью CLI:

```bash
meet2obsidian status
```

Эта команда покажет информацию, включая:
- Запущена ли служба мониторинга
- Отслеживаемую директорию
- Отслеживаемые шаблоны файлов
- Количество обработанных файлов
- Любые ожидающие обработки файлы
- Файлы, находящиеся в процессе обработки
- Последние ошибки обработки

Для получения более подробной информации о состоянии очереди:

```bash
meet2obsidian status --verbose
```

## Просмотр логов

Для просмотра подробных логов активности мониторинга файлов:

```bash
meet2obsidian logs
```

Вы также можете отфильтровать логи, чтобы видеть только записи, связанные с мониторингом файлов:

```bash
meet2obsidian logs --filter "file monitor"
```

Или логи, связанные с обработкой файлов:

```bash
meet2obsidian logs --filter "processing"
```

## Остановка и запуск мониторинга

Служба мониторинга файлов запускается автоматически со службой Meet2Obsidian. Вы можете управлять ею с помощью:

```bash
# Запуск службы
meet2obsidian service start

# Остановка службы
meet2obsidian service stop

# Перезапуск службы
meet2obsidian service restart
```

## Настройка обработки через конфигурационный файл

Все настройки также могут быть определены в конфигурационном файле YAML:

```yaml
paths:
  video_directory: "/Users/username/Documents/meet_records"
  obsidian_vault: "/Users/username/Documents/Obsidian/MainVault"
  log_directory: "/Users/username/Library/Logs/meet2obsidian"

processing:
  file_patterns: ["*.mp4", "*.mov", "*.webm", "*.mkv"]
  min_file_age_seconds: 5
  max_concurrent_files: 2
  max_retries: 3
  poll_interval: 60  # для устаревшего метода опроса (не используется, если доступны события ФС)
```

Чтобы импортировать конфигурацию из файла:

```bash
meet2obsidian config import /path/to/your/config.yaml
```

## Устранение неполадок

### Файлы не обнаруживаются

Если ваши файлы не обнаруживаются, проверьте:

1. **Правильную директорию**: Убедитесь, что настройка `paths.video_directory` указывает на правильное расположение
2. **Шаблоны файлов**: Убедитесь, что ваши типы файлов включены в настройку `processing.file_patterns`
3. **Разрешения**: Убедитесь, что Meet2Obsidian имеет доступ на чтение к директории
4. **Статус службы**: Проверьте, что служба запущена с помощью `meet2obsidian status`

### Файлы обнаружены, но не обрабатываются

Если файлы обнаруживаются, но не обрабатываются:

1. **Стабильность файла**: Файлы могут всё ещё копироваться — увеличьте `processing.min_file_age_seconds`, если необходимо
2. **Предыдущая обработка**: Проверьте, был ли файл уже обработан (указан в отчёте о статусе)
3. **Проверьте логи**: Ищите любые ошибки в логах с помощью `meet2obsidian logs`
4. **Очередь обработки**: Проверьте состояние очереди обработки с помощью `meet2obsidian status --verbose`

### Ошибки при обработке файлов

Если файлы добавляются в очередь, но завершаются с ошибками:

1. **Проверьте логи ошибок**: Используйте `meet2obsidian logs --level error` для просмотра ошибок
2. **Проверьте API-ключи**: Убедитесь, что API-ключи для сервисов транскрипции настроены правильно
3. **Формат файлов**: Удостоверьтесь, что файлы имеют корректный формат и не повреждены

## Лучшие практики

Для оптимальной производительности:

1. **Используйте отдельную директорию**: Отслеживайте специальную директорию, а не директорию общего назначения
2. **Ограничьте типы файлов**: Включайте в `processing.file_patterns` только те типы файлов, которые вам нужны
3. **Достаточное время стабильности**: Установите `processing.min_file_age_seconds` достаточно высоким, чтобы обеспечить полное копирование файла
4. **Регулярные проверки статуса**: Используйте `meet2obsidian status` для проверки корректной работы мониторинга
5. **Приоритетизация файлов**: Если у вас есть файлы, которые нужно обработать в первую очередь, переместите их в отдельную директорию с более высоким приоритетом

## Команды, связанные с обработкой файлов

```bash
# Просмотр всей очереди обработки
meet2obsidian process list

# Добавление файла в очередь с высоким приоритетом (3)
meet2obsidian process add /path/to/file.mp4 --priority 3

# Приостановка обработки очереди
meet2obsidian process pause

# Возобновление обработки очереди
meet2obsidian process resume

# Удаление файла из очереди
meet2obsidian process remove /path/to/file.mp4

# Повторная обработка файла, завершившегося с ошибкой
meet2obsidian process retry /path/to/file.mp4
```

> **Примечание**: Эти команды доступны, начиная с версии 1.2.0 Meet2Obsidian.